<!DOCTYPE html>
<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
        <link rel="stylesheet" type="text/css" href="webaudio.css">
        <script src="http://yastatic.net/jquery/1.8.3/jquery.min.js"></script>
        <script src="js/id3.min.js"></script>
        <script type="text/javascript">
            $(function() {
                var context = new (window.AudioContext || window.webkitAudioContext)(),
                    source,
                    analyser,
                    javascriptNode;

                var ctx = document.getElementById("canvas").getContext("2d");
                var gradient = ctx.createLinearGradient(0,0,0,400);
                gradient.addColorStop(1,'#000000');
                gradient.addColorStop(0.75,'#ff0000');
                gradient.addColorStop(0.25,'#ffff00');
                gradient.addColorStop(0,'#ffffff');

                function setupAudioNodes(source) {
                    javascriptNode = context.createScriptProcessor(2048, 1, 1);
                    javascriptNode.connect(context.destination);

                    javascriptNode.onaudioprocess = function() {

                        // get the average for the first channel
                        var array =  new Uint8Array(analyser.frequencyBinCount);
                        analyser.getByteFrequencyData(array);

                        // clear the current state
                        ctx.clearRect(0, 0, 1000, 400);

                        // set the fill style
                        ctx.fillStyle = gradient;
                        for(var i = 0; i < array.length; i++) {
                            ctx.fillRect(i*5, 400-array[i], 3, 400);
                        }
                    };

                    // setup a analyzer
                    analyser = context.createAnalyser();
                    analyser.smoothingTimeConstant = 0.3;
                    analyser.fftSize = 512;

                    // create a buffer source node
                    //source = context.createBufferSource();
                    source.connect(analyser);
                    analyser.connect(javascriptNode);

                    source.connect(context.destination);
                }

                var playMusic = function() {
                    var reader = new FileReader();
                    reader.onload = function(e) {
                        console.log(e);
                        id3(window.musicSource, function(err, tags) {
                            window.musicSource.tags = tags;
                        });
                        context.decodeAudioData(e.target.result, function(buffer) {
                            source = context.createBufferSource();
                            source.buffer = buffer;
                            setupAudioNodes(source);
                            //source.connect(context.destination);
                            source.start(0);
                            showNowPlaying();
                        }, function(error) {
                            console.error("failed to decode:", error);
                        });
                    };
                    reader.onerror = function(e) {
                        console.error(e);
                    };
                    reader.readAsArrayBuffer(window.musicSource);
                }

                var stopMusic = function() {
                    source && source.stop(0); 
                    hideNowPlaying();
                }

                var showNowPlaying = function() {
                    $(".now-playing-file").text("Now playing: " + window.musicSource.name);
                    $(".now-playing-artist").text("Artist: " + window.musicSource.tags.artist);
                    $(".now-playing-title").text("Title: " + window.musicSource.tags.title);
                }

                var hideNowPlaying = function() {
                    $(".now-playing-file").text("");
                    $(".now-playing-artist").text("");
                    $(".now-playing-title").text("");
                }
            
                $(".button-stop").addClass("hidden");

                $(".button-play" ).click(function() {
                    if (window.musicSource) {
                        $(this).addClass("hidden");
                        $(".button-stop").removeClass("hidden");
                        playMusic();
                    } else {
                        alert('Select the file first!');
                    }
                });

                $(".button-stop").click(function() {
                    $(this).addClass("hidden");
                    $(".button-play").removeClass("hidden");
                    stopMusic();
                });

                (function() {
                    $(".file-input").change(function(e) {
                        window.musicSource = e.target.files[0];
                    });

                    $(".grag-n-drop-area").click(function() {
                        $(".file-input").click();
                    });
                })();
            });
        </script>
    </head>
    <body>
        <div class="controls">
            <button class="button-play">Play</button>
            <button class="button-stop">Stop</button>
            <div class="uploader">
                <input class="file-input" type="file"/>
                <div class="grag-n-drop-area">Drag file here or click</div>
            </div>
        </div>
        <div>
            <p class="now-playing-file"></p>
            <p class="now-playing-artist"></p>
            <p class="now-playing-title"></p>
        </div>
        <canvas id="canvas" width="1000" height="400"></canvas>
    </body>
</html>
